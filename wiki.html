<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StreamBoard - Documentação Técnica</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");

      :root {
        --font-family-base: "Inter", sans-serif;
        --color-primary: #00c86f;
        --color-primary-hover: #05a35c;
        --color-error: #ef4444;
        --color-text: #2c2c2c;
        --color-muted: #666666;
        --color-background: #fbfbfb;
        --color-surface: #ffffff;
        --color-border: #e5e7eb;
        --color-input-bg: #f9fafb;
        --color-gray-dark: #111827;
        --shadow-md: 0 6px 16px rgba(0, 0, 0, 0.08);
        --radius: 10px;
      }

      body {
        font-family: var(--font-family-base);
        background-color: var(--color-background);
        color: var(--color-text);
        margin: 0;
        display: flex;
        line-height: 1.7;
      }

      nav.sidebar {
        width: 280px;
        background-color: var(--color-surface);
        border-right: 1px solid var(--color-border);
        padding: 2rem 0;
        height: 100vh;
        position: sticky;
        top: 0;
        flex-shrink: 0;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 0 1.5rem 1.5rem 1.5rem;
        text-align: center;
        border-bottom: 1px solid var(--color-border);
      }

      .sidebar-header img {
        max-width: 150px;
        margin-bottom: 0.5rem;
      }

      .sidebar-header h1 {
        font-size: 1.5rem;
        margin: 0;
        color: var(--color-text);
      }

      .sidebar-header .version {
        font-size: 0.8rem;
        font-weight: normal;
        background-color: var(--color-primary);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        vertical-align: middle;
        margin-left: 8px;
      }

      .sidebar ul {
        list-style: none;
        padding: 1rem 0;
        margin: 0;
      }

      .sidebar ul li .nav-header {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-muted);
        text-transform: uppercase;
        padding: 1rem 1.5rem 0.5rem 1.5rem;
      }

      .sidebar ul li a {
        display: block;
        padding: 0.75rem 1.5rem 0.75rem 2.5rem;
        color: var(--color-text);
        text-decoration: none;
        transition: background-color 0.2s;
        border-left: 4px solid transparent;
      }

      .sidebar ul li a:hover {
        background-color: #f3f4f6;
      }

      .sidebar ul li a.active {
        color: var(--color-primary);
        font-weight: 600;
        border-left-color: var(--color-primary);
        background-color: rgba(0, 200, 111, 0.05);
      }

      main {
        flex-grow: 1;
        padding: 1rem 3rem 3rem 3rem;
        max-width: 900px;
      }

      section {
        padding-top: 2rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--color-border);
      }

      section:last-child {
        border-bottom: none;
      }

      h2 {
        font-size: 2.5rem;
        color: var(--color-text);
        border-bottom: 3px solid var(--color-primary);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
      }

      h3 {
        font-size: 1.75rem;
        color: var(--color-gray-dark);
        margin-top: 2.5rem;
        margin-bottom: 1.25rem;
      }

      h4 {
        font-size: 1.25rem;
        color: var(--color-text);
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-left: 3px solid var(--color-primary);
        padding-left: 1rem;
      }

      p,
      li {
        font-size: 1rem;
        color: #4b5563;
      }

      code {
        background-color: var(--color-input-bg);
        border: 1px solid var(--color-border);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Fira Code", "Courier New", monospace;
        color: #c0392b;
      }

      pre {
        background-color: var(--color-gray-dark);
        color: #f1f1f1;
        border-radius: var(--radius);
        padding: 1rem;
        overflow-x: auto;
        white-space: pre-wrap;
        box-shadow: var(--shadow-md);
      }

      pre code {
        border: none;
        padding: 0;
        background-color: transparent;
        color: #dbeafe;
      }

      a {
        color: var(--color-primary);
        font-weight: 500;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        overflow: hidden;
      }

      th,
      td {
        padding: 0.8rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--color-border);
      }

      tr:last-child td {
        border-bottom: none;
      }

      th {
        background-color: var(--color-input-bg);
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--color-muted);
      }
    </style>
  </head>
  <body>
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="public/assets/logo.png" alt="StreamBoard Logo" />
        <h1>StreamBoard <span class="version">v1.0</span></h1>
      </div>
      <ul>
        <li><a href="#visao-geral">Visão Geral</a></li>
        <li><a href="#tecnologias">Tecnologias</a></li>
        <li><a href="#como-executar">Como Executar</a></li>
        <li><div class="nav-header">Backend</div></li>
        <li><a href="#backend-estrutura">Estrutura de Pastas</a></li>
        <li><a href="#backend-controllers">Controladores</a></li>
        <li><a href="#backend-services">Serviços</a></li>
        <li><a href="#backend-routes">Rotas</a></li>
        <li><div class="nav-header">Frontend</div></li>
        <li><a href="#frontend-estrutura">Estrutura de Pastas</a></li>
        <li><a href="#frontend-modulos">Módulos JS</a></li>
        <li><div class="nav-header">Outros</div></li>
        <li><a href="#database">Banco de Dados</a></li>
        <li><a href="#env">Variáveis de Ambiente</a></li>
      </ul>
    </nav>

    <main>
      <section id="visao-geral">
        <h2>Visão Geral</h2>
        <p>
          O <strong>StreamBoard</strong> é um sistema de gerenciamento de
          conteúdo para sinalização digital (Digital Signage). Ele permite que
          administradores gerenciem empresas, setores e dispositivos, criando e
          agendando campanhas de mídia (imagens e vídeos) para serem exibidas em
          diferentes telas.
        </p>
      </section>

      <section id="tecnologias">
        <h2>Tecnologias</h2>
        <ul>
          <li>
            <strong>Backend:</strong> Node.js, Express.js, WebSocket (ws),
            PostgreSQL (node-postgres), JWT.
          </li>
          <li>
            <strong>Frontend:</strong> EJS (Templates), JavaScript (ES6
            Modules), Notyf, Flatpickr, TomSelect, SortableJS.
          </li>
          <li><strong>Banco de Dados:</strong> PostgreSQL.</li>
        </ul>
      </section>

      <section id="como-executar">
        <h2>Como Executar o Projeto</h2>
        <h3>1. Instalação</h3>
        <pre><code># Instale as dependências
npm install</code></pre>

        <h3>2. Configuração do <code>.env</code></h3>
        <p>
          Crie um arquivo <code>.env</code> na raiz do projeto e preencha as
          variáveis de ambiente necessárias (veja a seção
          <a href="#env">Variáveis de Ambiente</a>).
        </p>

        <h3>3. Banco de Dados</h3>
        <p>
          Com o PostgreSQL rodando, execute o script de setup para criar o banco
          de dados e as tabelas. Este comando irá apagar e recriar o banco de
          dados definido no <code>.env</code>.
        </p>
        <pre><code>node setup.js</code></pre>

        <h3>4. Criando um Usuário Admin</h3>
        <p>
          Como não há tela de registro, você precisa criar um usuário
          administrador manualmente. Conecte-se ao seu banco de dados e execute
          um comando SQL similar a este (substitua com uma senha forte):
        </p>
        <pre><code>-- Lembre-se que a senha precisa ser o HASH bcrypt. 
-- Você pode gerar um hash usando um script Node.js simples.
INSERT INTO users (username, password, email, user_role) 
VALUES ('admin', '[SEU_HASH_BCRYPT_AQUI]', 'admin@email.com', 'admin');</code></pre>

        <h3>5. Iniciando o Servidor</h3>
        <pre><code>npm start</code></pre>
      </section>

      <section id="backend-estrutura">
        <h2>Estrutura do Backend</h2>
        <p>
          O backend segue uma arquitetura em camadas (<strong
            >Monolito Modular</strong
          >) para garantir a separação de responsabilidades.
        </p>
        <h4>server.js</h4>
        <p>
          Ponto de entrada da aplicação. Responsável por inicializar o servidor
          Express, WebSockets, middlewares globais e carregar as rotas.
        </p>

        <h4>/config/</h4>
        <p>
          Armazena as configurações de conexão com serviços externos, como os
          diferentes bancos de dados.
        </p>

        <h4>/src/routes/</h4>
        <p>
          Define todos os endpoints (URLs) da aplicação e os conecta às funções
          dos controladores. Atua como o mapa da API.
        </p>

        <h4>/src/middlewares/</h4>
        <p>
          Contém funções que são executadas antes de uma requisição chegar ao
          seu destino final, usadas para autenticação, autorização e validação.
        </p>

        <h4>/src/controllers/</h4>
        <p>
          Orquestra o fluxo da requisição. Recebe os dados, chama os serviços
          para executar a lógica de negócio e formata a resposta a ser enviada
          ao cliente.
        </p>

        <h4>/src/services/</h4>
        <p>
          Onde a lógica de negócio principal reside. Manipula dados, interage
          com o banco de dados e executa as regras da aplicação.
        </p>

        <h4>/src/utils/</h4>
        <p>
          Funções auxiliares e reutilizáveis sem lógica de negócio específica
          (ex: logger, formatadores de data).
        </p>
      </section>

      <section id="backend-controllers">
        <h3>Controladores</h3>
        <p>
          Cada controlador gerencia um recurso específico da aplicação, atuando
          como uma ponte entre as rotas e os serviços.
        </p>
        <table>
          <tr>
            <th>Arquivo</th>
            <th>Responsabilidade</th>
          </tr>
          <tr>
            <td><code>admin.controller.js</code></td>
            <td>
              Gerencia rotas administrativas básicas como o dashboard e o
              redirecionamento da raiz.
            </td>
          </tr>
          <tr>
            <td><code>api.controller.js</code></td>
            <td>
              Controla endpoints de API genéricos, como a busca de produtos.
            </td>
          </tr>
          <tr>
            <td><code>auth.controller.js</code></td>
            <td>
              Lida com a lógica de login e logout do painel administrativo.
            </td>
          </tr>
          <tr>
            <td><code>campaign.controller.js</code></td>
            <td>
              Gerencia todas as ações de Campanhas (listar, criar, editar,
              deletar, obter detalhes).
            </td>
          </tr>
          <tr>
            <td><code>company.controller.js</code></td>
            <td>
              Gerencia todas as ações de Empresas e Setores (listar, criar,
              editar, deletar, etc).
            </td>
          </tr>
          <tr>
            <td><code>device.controller.js</code></td>
            <td>
              Gerencia todas as ações de Dispositivos (listar, criar, editar,
              deletar, gerar OTP, etc).
            </td>
          </tr>
          <tr>
            <td><code>player.controller.js</code></td>
            <td>
              Controla a renderização das páginas dos dispositivos (Player,
              Consulta Preços) e a lógica de pareamento (Pairing).
            </td>
          </tr>
        </table>
      </section>

      <section id="backend-services">
        <h3>Serviços</h3>
        <p>
          Os serviços contêm a lógica de negócio e a comunicação com o banco de
          dados, isolando a complexidade dos controladores.
        </p>
        <table>
          <tr>
            <th>Arquivo</th>
            <th>Responsabilidade</th>
          </tr>
          <tr>
            <td><code>auth.service.js</code></td>
            <td>Valida credenciais de usuário e revoga tokens.</td>
          </tr>
          <tr>
            <td><code>campeao.service.js</code></td>
            <td>
              Encapsula a comunicação com a API GraphQL externa do Campeão.
            </td>
          </tr>
          <tr>
            <td><code>campaign.service.js</code></td>
            <td>
              Lida com as operações de banco de dados para campanhas e suas
              mídias.
            </td>
          </tr>
          <tr>
            <td><code>company.service.js</code></td>
            <td>
              Lida com as operações de banco de dados para empresas e setores.
            </td>
          </tr>
          <tr>
            <td><code>device.service.js</code></td>
            <td>Lida com as operações de banco de dados para dispositivos.</td>
          </tr>
          <tr>
            <td><code>pairing.service.js</code></td>
            <td>
              Contém a lógica transacional para pareamento de dispositivos via
              OTP e Magic Link.
            </td>
          </tr>
          <tr>
            <td><code>product.service.js</code></td>
            <td>
              Busca informações de produtos, combinando dados do Sysmo e da API
              do Campeão.
            </td>
          </tr>
          <tr>
            <td><code>token.service.js</code></td>
            <td>
              Responsável por gerar e verificar os tokens JWT para os
              dispositivos.
            </td>
          </tr>
        </table>
      </section>

      <section id="backend-routes">
        <h3>Rotas</h3>
        <p>
          Cada arquivo de rota define um conjunto de endpoints relacionados a um
          recurso específico.
        </p>
        <table>
          <tr>
            <th>Arquivo</th>
            <th>Exemplo de Rota</th>
            <th>Descrição</th>
          </tr>
          <tr>
            <td><code>admin.routes.js</code></td>
            <td><code>GET /dashboard</code></td>
            <td>Rotas para páginas e ações gerais do painel de admin.</td>
          </tr>
          <tr>
            <td><code>api.routes.js</code></td>
            <td><code>GET /api/product/:barcode</code></td>
            <td>Endpoints de API que não se encaixam em outros recursos.</td>
          </tr>
          <tr>
            <td><code>auth.routes.js</code></td>
            <td><code>POST /login</code></td>
            <td>Rotas de autenticação para o painel de admin.</td>
          </tr>
          <tr>
            <td><code>campaign.routes.js</code></td>
            <td><code>POST /campaigns</code></td>
            <td>Todas as rotas para gerenciar campanhas.</td>
          </tr>
          <tr>
            <td><code>company.routes.js</code></td>
            <td><code>GET /companies</code></td>
            <td>Todas as rotas para gerenciar empresas e seus setores.</td>
          </tr>
          <tr>
            <td><code>device.routes.js</code></td>
            <td><code>POST /devices/:id/otp</code></td>
            <td>Todas as rotas para gerenciar dispositivos.</td>
          </tr>
          <tr>
            <td><code>player.routes.js</code></td>
            <td><code>GET /player</code></td>
            <td>
              Rotas que os dispositivos acessam (pareamento, player, etc).
            </td>
          </tr>
          <tr>
            <td><code>index.js</code></td>
            <td><code>router.use(...)</code></td>
            <td>
              Arquivo principal que unifica e exporta todas as outras rotas.
            </td>
          </tr>
        </table>
      </section>

      <section id="frontend-estrutura">
        <h2>Estrutura do Frontend</h2>
        <p>
          O código JavaScript do lado do cliente está na pasta
          <code>/public/js</code> e é dividido por responsabilidade
          (cliente-admin vs. cliente-dispositivo).
        </p>
        <pre><code>/public/js/
├── /admin/      (Scripts exclusivos do Painel Admin)
├── /player/     (Scripts dos dispositivos: Player e Consulta Preços)
├── /utils/      (Utilitários compartilhados, como o connector.js)
└── main.js      (Ponto de entrada que carrega os módulos do admin)</code></pre>
      </section>

      <section id="frontend-modulos">
        <h3>Módulos JS</h3>
        <p>
          Cada arquivo JS tem uma responsabilidade bem definida para gerenciar a
          interatividade da interface.
        </p>
        <table>
          <tr>
            <th>Arquivo</th>
            <th>Responsabilidade</th>
          </tr>
          <tr>
            <td><code>main.js</code></td>
            <td>
              Ponto de entrada principal. Importa e inicializa todos os módulos
              do painel de administração.
            </td>
          </tr>
          <tr>
            <td><code>admin/utils.js</code></td>
            <td>
              Exporta instâncias e funções compartilhadas pelo painel, como o
              Notyf.
            </td>
          </tr>
          <tr>
            <td><code>admin/companyModal.js</code></td>
            <td>Gerencia a lógica do modal de criação e edição de empresas.</td>
          </tr>
          <tr>
            <td><code>admin/deviceModal.js</code></td>
            <td>
              Gerencia a lógica do modal de criação e edição de dispositivos.
            </td>
          </tr>
          <tr>
            <td><code>admin/campaignModal.js</code></td>
            <td>
              Lida com a complexa lógica do modal de campanhas, incluindo
              uploads e segmentação.
            </td>
          </tr>
          <tr>
            <td><code>admin/detailsModal.js</code></td>
            <td>
              Controla a exibição e interatividade do modal de detalhes do
              dispositivo.
            </td>
          </tr>
          <tr>
            <td><code>admin/adminWs.js</code></td>
            <td>
              Gerencia a conexão WebSocket do painel de admin para receber
              atualizações em tempo real.
            </td>
          </tr>
          <tr>
            <td><code>player/player.js</code></td>
            <td>
              Controla a lógica do player de mídia, buscando playlists e
              exibindo o conteúdo.
            </td>
          </tr>
          <tr>
            <td><code>player/price.js</code></td>
            <td>Controla a lógica do terminal de consulta de preços.</td>
          </tr>
          <tr>
            <td><code>utils/connector.js</code></td>
            <td>
              Classe reutilizável que gerencia a conexão WebSocket para os
              dispositivos.
            </td>
          </tr>
        </table>
      </section>

      <section id="database">
        <h2>Banco de Dados</h2>
        <p>
          O projeto utiliza PostgreSQL. O arquivo <code>setup.js</code> é um
          script utilitário para criar e resetar o banco de dados do zero,
          aplicando todo o schema. É ideal para preparar o ambiente de
          desenvolvimento.
        </p>
      </section>

      <section id="env">
        <h2>Variáveis de Ambiente (.env)</h2>
        <p>
          Estas são as variáveis necessárias no arquivo <code>.env</code> para
          que a aplicação funcione.
        </p>
        <table>
          <thead>
            <tr>
              <th>Variável</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>PORT</code></td>
              <td>Porta em que o servidor web irá rodar.</td>
            </tr>
            <tr>
              <td><code>DB_USER</code></td>
              <td>Usuário do banco de dados PostgreSQL.</td>
            </tr>
            <tr>
              <td><code>DB_PASSWORD</code></td>
              <td>Senha do usuário do PostgreSQL.</td>
            </tr>
            <tr>
              <td><code>DB_HOST</code></td>
              <td>Endereço do servidor de banco de dados.</td>
            </tr>
            <tr>
              <td><code>DB_PORT</code></td>
              <td>Porta do servidor de banco de dados.</td>
            </tr>
            <tr>
              <td><code>DB_NAME</code></td>
              <td>Nome do banco de dados a ser usado/criado.</td>
            </tr>
            <tr>
              <td><code>SESSION_SECRET</code></td>
              <td>
                String longa e aleatória para proteger as sessões dos usuários.
              </td>
            </tr>
            <tr>
              <td><code>JWT_SECRET</code></td>
              <td>
                String longa e aleatória para assinar os tokens JWT dos
                dispositivos.
              </td>
            </tr>
            <tr>
              <td><code>CAMPEAO_API_EMAIL</code></td>
              <td>Email para autenticar na API externa do Campeão.</td>
            </tr>
            <tr>
              <td><code>CAMPEAO_API_PASSWORD</code></td>
              <td>Senha para autenticar na API externa do Campeão.</td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const sections = document.querySelectorAll("main section");
        const navLinks = document.querySelectorAll(".sidebar a");

        if (!sections.length || !navLinks.length) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                navLinks.forEach((link) => {
                  link.classList.remove("active");
                  if (link.getAttribute("href") === `#${entry.target.id}`) {
                    link.classList.add("active");
                  }
                });
              }
            });
          },
          { rootMargin: "-40% 0px -60% 0px", threshold: 0 }
        );

        sections.forEach((section) => observer.observe(section));

        navLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = e.currentTarget.getAttribute("href");
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: "smooth" });
            }
          });
        });
      });
    </script>
  </body>
</html>
